#+title: annas-archive: Search and download from Anna's Archive
#+author: Pablo Stafforini
#+email: pablo@stafforini.com
#+language: en
#+options: ':t toc:t author:t email:t num:t
#+startup: content
#+export_file_name: annas-archive.info
#+texinfo_filename: annas-archive.info
#+texinfo_dir_category: Emacs misc features
#+texinfo_dir_title: Anna's Archive: (annas-archive)
#+texinfo_dir_desc: Search and download from Anna's Archive

This manual describes the features and customization options for the Emacs Lisp file =annas-archive.el=.

* Overview
:PROPERTIES:
:CUSTOM_ID: h:overview
:END:

=annas-archive.el= provides Emacs integration for [[https://annas-archive.li/][Anna's Archive]], the largest search engine for shadow libraries. It lets you search for books and papers by title, ISBN, or DOI, browse results in a formatted completion interface, and download files---all without leaving Emacs.

The package works by driving Emacs's built-in =eww= browser behind the scenes to load search results from Anna's Archive, parsing the rendered HTML to extract bibliographic metadata (title, file type, size, language, and year), and presenting the results via ~completing-read~. When the user selects a result, the package navigates to the item page and initiates a download.

Two download mechanisms are available:

- *Programmatic download via the fast download API.* When ~annas-archive-secret-key~ is set, the package calls the Anna's Archive JSON API to obtain a direct download URL, then retrieves the file asynchronously within Emacs and saves it to ~annas-archive-downloads-dir~ ([[#h:download-options][Download options]]).

- *External browser fallback.* When the API key is not set, or when a programmatic download fails, the package opens the download URL in the system's default browser. This behavior is governed by ~annas-archive-when-download-fails~ ([[#h:download-failure-handling][Download failure handling]]).

The package depends only on libraries bundled with Emacs: =cl-lib=, =json=, =url-parse=, =url-util=, and =eww=.

** DOI support
:PROPERTIES:
:CUSTOM_ID: h:doi-support
:END:

When the search string is a DOI (e.g. =10.1145/1458082.1458150=), the package bypasses the normal search flow and navigates directly to the SciDB page for that DOI. From there it extracts the MD5 hash of the associated file and proceeds with the download. This makes it straightforward to fetch papers by DOI.

** Breaking change (February 2026)
:PROPERTIES:
:CUSTOM_ID: h:breaking-change
:END:

As of February 2026, Anna's Archive changed their download flow so that the "Download" links on item pages are now JavaScript-driven. This broke the previous =eww=-based download mechanism. Programmatic downloads now use the [[https://annas-archive.li/dyn/api/fast_download.json][fast download JSON API]], which requires a *secret key*.

If you were using ~annas-archive-use-fast-download-links~ and/or ~annas-archive-use-eww~, replace them with ~annas-archive-secret-key~:

#+begin_src emacs-lisp
;; Before:
(setq annas-archive-use-fast-download-links t)
(setq annas-archive-use-eww t)

;; After:
(setq annas-archive-secret-key "YOUR_SECRET_KEY")
#+end_src

To find your key, log into Anna's Archive with your paid membership and visit your [[https://annas-archive.li/account/][account page]]. Both ~annas-archive-use-fast-download-links~ and ~annas-archive-use-eww~ are now obsolete.

* Installation
:PROPERTIES:
:CUSTOM_ID: h:installation
:END:

** Manual installation
:PROPERTIES:
:CUSTOM_ID: h:manual-installation
:END:

Clone the repository and add it to your load path:

#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/annas-archive/")
(require 'annas-archive)
#+end_src

** Installation with use-package
:PROPERTIES:
:CUSTOM_ID: h:use-package-installation
:END:

If you use ~use-package~, add one of the following snippets to your init file:

#+begin_src emacs-lisp
;; with vc (Emacs 30+)
(use-package annas-archive
  :vc (:url "https://github.com/benthamite/annas-archive"))

;; with elpaca
(use-package annas-archive
  :ensure (:host github :repo "benthamite/annas-archive"))

;; with straight
(use-package annas-archive
  :straight (:host github :repo "benthamite/annas-archive"))

;; with quelpa
(use-package annas-archive
  :quelpa (annas-archive :fetcher github :repo "benthamite/annas-archive"))
#+end_src

* User options
:PROPERTIES:
:CUSTOM_ID: h:user-options
:END:

** Download options
:PROPERTIES:
:CUSTOM_ID: h:download-options
:END:

#+vindex: annas-archive-secret-key
#+vindex: annas-archive-downloads-dir
#+vindex: annas-archive-post-download-hook

The user option ~annas-archive-secret-key~ specifies the secret key for the Anna's Archive fast download API. When set to a non-empty string, it enables programmatic downloads directly within Emacs: the package calls the API to get a direct download URL, retrieves the file asynchronously, and saves it to disk. The default value is ~nil~, which means programmatic downloads are disabled and the package will fall back to opening the download URL in the system browser.

To obtain a secret key, you need a paid [[https://annas-archive.li/donate][membership]] on Anna's Archive. Once logged in, visit the [[https://annas-archive.li/account/][account page]] to find your key.

The user option ~annas-archive-downloads-dir~ specifies the directory where programmatically downloaded files are saved. The default value is =~/Downloads/=. This option is only relevant when ~annas-archive-secret-key~ is set; external browser downloads go to whatever location the browser is configured to use.

The user option ~annas-archive-post-download-hook~ is a hook run after downloading a file. Each function on the hook is called with the download URL as its first argument. When the file was downloaded programmatically (i.e. via the fast download API), the destination file path is passed as the second argument. This is useful for post-processing, such as automatically renaming or moving the downloaded file. The default value is ~nil~.

** Download failure handling
:PROPERTIES:
:CUSTOM_ID: h:download-failure-handling
:END:

#+vindex: annas-archive-when-download-fails

The user option ~annas-archive-when-download-fails~ controls what happens when a programmatic download fails. It accepts one of three values:

- ~external~ (the default): open the download URL in the system's default browser so the user can complete the download manually.
- ~error~: signal an error, which is useful in non-interactive scripts where silent failure is undesirable.
- ~nil~: fail silently with only a message in the echo area.

A programmatic download can fail for several reasons: the fast download API may return an error (e.g. daily quota exhausted, invalid key), the remote server may return an HTML challenge page instead of the file, or the connection may time out.

** Search filtering
:PROPERTIES:
:CUSTOM_ID: h:search-filtering
:END:

#+vindex: annas-archive-included-file-types
#+vindex: annas-archive-retry-with-all-file-types

The user option ~annas-archive-included-file-types~ specifies which file extensions to include when displaying search results. The value is a list of lowercase extension strings. The default includes all types supported by the package: =pdf=, =epub=, =fb2=, =mobi=, =cbr=, =djvu=, =cbz=, =txt=, and =azw3=.

If you only want PDF and EPUB results, for example:

#+begin_src emacs-lisp
(setq annas-archive-included-file-types '("pdf" "epub"))
#+end_src

The user option ~annas-archive-retry-with-all-file-types~ controls whether the package automatically retries a search with all supported file types when the filtered search returns no results. When set to ~t~ (the default), the package prompts with a =y-or-n= question before retrying. Set it to ~nil~ to disable this behavior.

** Column widths
:PROPERTIES:
:CUSTOM_ID: h:column-widths
:END:

#+vindex: annas-archive-title-column-width
#+vindex: annas-archive-type-column-width
#+vindex: annas-archive-size-column-width
#+vindex: annas-archive-year-column-width
#+vindex: annas-archive-language-column-width

The following user options control the column widths in the formatted completion candidates displayed by ~annas-archive-download~ ([[#h:searching-and-downloading][Searching and downloading]]). Each value is an integer specifying the number of characters.

| User option                              | Default | Description     |
|------------------------------------------+---------+-----------------|
| ~annas-archive-title-column-width~       |     100 | Title column    |
| ~annas-archive-type-column-width~        |       5 | File type       |
| ~annas-archive-size-column-width~        |       8 | File size       |
| ~annas-archive-year-column-width~        |       4 | Publication year |
| ~annas-archive-language-column-width~    |      20 | Language        |

You may want to reduce ~annas-archive-title-column-width~ if you work with a narrow frame, or increase ~annas-archive-language-column-width~ if you frequently encounter entries with multiple languages.

* Commands
:PROPERTIES:
:CUSTOM_ID: h:commands
:END:

** Searching and downloading
:PROPERTIES:
:CUSTOM_ID: h:searching-and-downloading
:END:

#+findex: annas-archive-download

The command ~annas-archive-download~ is the main entry point for the package. When called interactively via =M-x annas-archive-download=, it prompts for a search string. The search string can be:

- A book title, author name, or any descriptive text.
- An ISBN.
- A DOI (e.g. =10.1145/1458082.1458150=) for academic papers.

The command loads the Anna's Archive search results page in =eww= behind the scenes, parses the rendered results to extract titles, file types, sizes, languages, and publication years, and presents them in a formatted ~completing-read~ interface. After you select a result, the package navigates to the item's detail page and initiates the download.

When the search string is a DOI, the command skips the search step and navigates directly to the SciDB page for that DOI, proceeding straight to download ([[#h:doi-support][DOI support]]).

When called non-interactively, the command expects a non-empty string argument and does not prompt. It signals an error if the argument is ~nil~ or empty. This makes it suitable for use in Lisp code:

#+begin_src emacs-lisp
(annas-archive-download "10.1145/1458082.1458150")
#+end_src

** Downloading from an eww buffer
:PROPERTIES:
:CUSTOM_ID: h:downloading-from-eww
:END:

#+findex: annas-archive-download-file
#+findex: annas-archive-ensure-download-page

The command ~annas-archive-download-file~ downloads the file from the Anna's Archive item page currently displayed in =eww=. This is useful when you have navigated to an item page manually in =eww= and want to trigger the download without going through the search flow.

The command first verifies that the current buffer is an =eww= buffer displaying a valid Anna's Archive download page (an MD5 or SciDB URL). If ~annas-archive-secret-key~ is set, it uses the fast download API to retrieve the file programmatically ([[#h:download-options][Download options]]). Otherwise, it falls back according to ~annas-archive-when-download-fails~ ([[#h:download-failure-handling][Download failure handling]]).

When called interactively, it displays a message indicating the download directory. When called non-interactively (e.g. from a hook), it silently kills the =eww= buffer after initiating the download.

The command ~annas-archive-ensure-download-page~ is a guard that verifies the current buffer is an =eww= buffer showing a valid Anna's Archive item page. It signals a ~user-error~ if the buffer is not in =eww-mode=, has no URL, or the URL does not match the expected pattern. This command is called internally by ~annas-archive-download-file~ but is also available for use in custom workflows.

** Selecting from search results
:PROPERTIES:
:CUSTOM_ID: h:selecting-from-results
:END:

#+findex: annas-archive-collect-results

The command ~annas-archive-collect-results~ parses the current =eww= buffer as an Anna's Archive search results page, filters the results by file type, and presents them for selection via ~completing-read~. It accepts an optional TYPES argument (a list of lowercase extension strings) to override the default filter from ~annas-archive-included-file-types~ ([[#h:search-filtering][Search filtering]]).

This command is typically called automatically as part of the ~annas-archive-download~ workflow, but it can also be invoked interactively from an =eww= buffer displaying Anna's Archive search results.

* Functions
:PROPERTIES:
:CUSTOM_ID: h:functions
:END:

** Parsing search results
:PROPERTIES:
:CUSTOM_ID: h:parsing-functions
:END:

#+findex: annas-archive-parse-results
#+findex: annas-archive-get-links

The function ~annas-archive-parse-results~ parses the current =eww= buffer, which should contain Anna's Archive search results, and returns a list of plists. Each plist has the keys ~:title~, ~:url~, ~:type~, ~:size~, ~:language~, and ~:year~. This function is the backbone of the result-selection interface and can be used in custom Lisp code to extract structured data from a search results page.

The function ~annas-archive-get-links~ extracts all hyperlinks from the current =eww= buffer as an alist of =(TITLE . URL)= pairs. It walks the buffer's text properties to find regions with the ~shr-url~ property, which is how =shr= (the HTML renderer used by =eww=) marks links. While primarily used internally by ~annas-archive-parse-results~, it may be useful for other =eww=-based scraping tasks.

** Download helpers
:PROPERTIES:
:CUSTOM_ID: h:download-helpers
:END:

#+findex: annas-archive-download-file-internally
#+findex: annas-archive-download-file-externally
#+findex: annas-archive-download-file-callback
#+findex: annas-archive-save-file
#+findex: annas-archive-handle-download-failure
#+findex: annas-archive-select-and-open-url

The function ~annas-archive-download-file-internally~ initiates an asynchronous download of the file at a given URL using ~url-retrieve~. It takes the URL and a descriptive speed string (e.g. ="fast"=) as arguments. The actual file saving is handled by the callback returned by ~annas-archive-download-file-callback~ ([[#h:download-options][Download options]]).

The function ~annas-archive-download-file-externally~ opens the given URL in the system's default browser using ~browse-url-default-browser~ and runs ~annas-archive-post-download-hook~ with the URL as argument.

The function ~annas-archive-download-file-callback~ returns a closure suitable for use as a ~url-retrieve~ callback. The closure handles HTTP errors, determines the file extension from the response (trying the redirect URL, Content-Type header, and original URL in turn), strips HTTP headers from the response buffer, detects HTML challenge pages, and saves the file via ~annas-archive-save-file~.

The function ~annas-archive-save-file~ writes the current buffer contents to the given path using binary (no-conversion) coding, creating the parent directory if needed. It then runs ~annas-archive-post-download-hook~ with the URL and file path.

The function ~annas-archive-handle-download-failure~ dispatches on the value of ~annas-archive-when-download-fails~ to either open the URL externally, signal an error, or fail silently ([[#h:download-failure-handling][Download failure handling]]).

The function ~annas-archive-select-and-open-url~ is an ~eww-after-render-hook~ callback that triggers the result-selection interface after =eww= finishes rendering a search results page. It removes itself from the hook, calls ~annas-archive-collect-results~ ([[#h:selecting-from-results][Selecting from search results]]), and handles the retry-with-all-file-types logic controlled by ~annas-archive-retry-with-all-file-types~ ([[#h:search-filtering][Search filtering]]).

* Troubleshooting
:PROPERTIES:
:CUSTOM_ID: h:troubleshooting
:END:

** Anna's Archive domain changes
:PROPERTIES:
:CUSTOM_ID: h:domain-changes
:END:

Anna's Archive frequently changes its domain name. If the package stops working, check the [[https://en.wikipedia.org/wiki/Anna%27s_Archive][Wikipedia article]] for the current URL and update ~annas-archive-home-url~ accordingly:

#+begin_src emacs-lisp
(setq annas-archive-home-url "https://NEW-DOMAIN/")
#+end_src

Note the trailing slash, which is required.

** No results found
:PROPERTIES:
:CUSTOM_ID: h:no-results
:END:

If a search returns no results, it may be because ~annas-archive-included-file-types~ is set to a restrictive list. The package will prompt you to retry with all file types if ~annas-archive-retry-with-all-file-types~ is ~t~ ([[#h:search-filtering][Search filtering]]).

** API errors
:PROPERTIES:
:CUSTOM_ID: h:api-errors
:END:

The fast download API can return several errors. The package translates them into user-friendly messages:

| API error                          | Meaning                                       |
|------------------------------------+-----------------------------------------------|
| Invalid secret key                 | The value of ~annas-archive-secret-key~ is wrong |
| Not a member                       | Your account lacks a paid membership           |
| No downloads left                  | Daily download quota exhausted                 |
| Record not found                   | The file does not exist in Anna's Archive      |
| Invalid domain_index or path_index | File unavailable for fast download             |
| Error during fetching              | Server-side error                              |

** Reporting issues
:PROPERTIES:
:CUSTOM_ID: h:reporting-issues
:END:

If you encounter problems not covered here, please open an issue on the [[https://github.com/benthamite/annas-archive][GitHub repository]].

* Indices
:PROPERTIES:
:CUSTOM_ID: h:indices
:END:

** Function index
:PROPERTIES:
:INDEX: fn
:CUSTOM_ID: h:function-index
:END:

** Variable index
:PROPERTIES:
:INDEX: vr
:CUSTOM_ID: h:variable-index
:END:
